trigger:
  branches:
    include:
      - main

variables:
  - group: lab-vg-helloworld

stages:

  # ======================
  # BUILD STAGE (CI)
  # ======================
  - stage: Build
    displayName: "CI - Build & Test"
    jobs:
      - job: BuildJob
        displayName: "Build Node.js Function App"
        pool:
          name: self-hosted-lab-pool   # << your self-hosted agent pool

        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: "Use Node.js 20"

          - script: npm install
            displayName: "Install Dependencies"

          # (Optional) Remove if no tests in project
          - script: npm test
            continueOnError: true
            displayName: "Run Unit Tests (Optional)"

          # Create zip artifact
          - task: ArchiveFiles@2
            displayName: "Archive Function App Files"
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/drop.zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: "Publish ZIP Artifact"
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'

  # ======================
  # DEPLOY STAGE (CD)
  # ======================
  - stage: Deploy
    displayName: "CD - Deploy to Azure"
    dependsOn: Build
    condition: succeeded()

    jobs:
      - deployment: DeployJob
        environment: "Production"
        pool:
          name: self-hosted-lab-pool   # Use same agent pool

        strategy:
          runOnce:
            deploy:
              steps:

                - task: DownloadBuildArtifacts@0
                  displayName: "Download Build Artifact"
                  inputs:
                    artifactName: "drop"

                - task: AzureFunctionApp@2
                  displayName: "Deploy to Azure Function App"
                  inputs:
                    azureSubscription: "azure-serviceconn-lab"
                    appName: "$(AZURE_FUNCTION_APP_NAME)"
                    appType: "functionApp"
                    package: "$(Pipeline.Workspace)/drop/drop.zip"